#!/bin/bash

# Exit code :
#   - 0: the dump has been updated successfully and is heavier than before, meaning more data has been dumped
#   - 1: the dump has been updated successfully but it seems that the whole size of it didn't change
#   - 2: the dump has been updated successfully but is less heavy than before, it may be normal due to compression,
# or it could also indicate a data loss or an issue that happened during the dump without making it crash
#   - 3: something went wrong

set -Eeu -o pipefail

trap "exit 3" ERR

MONGODB_DUMP_LOCATION="docker/files/mongodb"
MONGO_WORKING_DIR="/install"

db_dump_size_before=$(du -bc "$MONGODB_DUMP_LOCATION/db_dump_part"* | tail -1 | cut -f1)

docker compose cp "$MONGODB_DUMP_LOCATION/data_dump_compress.sh" "mongo:$MONGO_WORKING_DIR/data_dump_compress.sh"
docker compose exec mongo "$MONGO_WORKING_DIR/data_dump_compress.sh"

docker compose cp "mongo:$MONGO_WORKING_DIR/db_dump.7z" "$MONGODB_DUMP_LOCATION"
split -b 50M "$MONGODB_DUMP_LOCATION/db_dump.7z" "$MONGODB_DUMP_LOCATION/db_dump_part"
rm "$MONGODB_DUMP_LOCATION/db_dump.7z"
docker compose exec mongo rm "$MONGO_WORKING_DIR/data_dump_compress.sh" "$MONGO_WORKING_DIR/db_dump.7z"

echo "Total size of dump files"
du -bc "$MONGODB_DUMP_LOCATION/db_dump_part"* | tail -1 | cut -f1

db_dump_size_after=$(du -bc "$MONGODB_DUMP_LOCATION/db_dump_part"* | tail -1 | cut -f1)
echo "Database dump finished, sum of binary files db_dump_part* is:"
echo "Before: $db_dump_size_before"
echo "After: $db_dump_size_after"

db_dump_size_diff="$(($db_dump_size_after-$db_dump_size_before))"

if [ "$db_dump_size_diff" -gt 0 ]; then
    echo "The size of the dump files is $db_dump_size_diff bytes bigger"
    exit 0
elif [ "$db_dump_size_diff" -eq 0 ]; then
    echo "The size of the dump files remains unchanged"
    exit 1
else
    echo "The size of the dump files have decreased of $db_dump_size_diff bytes. That's odd."
    exit 2
fi
